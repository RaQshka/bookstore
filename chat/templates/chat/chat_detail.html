{% extends 'base.html' %}
{% block title %}Чат{% endblock %}
{% block content %}
<div class="container mt-4">
    <h2>Чат по объявлению: {{ chat.listing.title }}</h2>
    <div class="card">
        <div class="card-body">
            <div id="messages" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
                {% for message in messages %}
                    <div style="margin-bottom: 10px; padding: 10px; border-radius: 5px; {% if message.sender == request.user %}background-color: #e9ecef; text-align: right;{% else %}background-color: #f8f9fa; text-align: left;{% endif %}">
                        <p><strong>{{ message.sender.username }}</strong> ({{ message.sent_at|date:"d.m.Y H:i" }}):</p>
                        <p>{{ message.text|linebreaks }}</p>
                    </div>
                {% endfor %}
            </div>
            <form id="message-form">
                {% csrf_token %}
                {{ form.as_p }}
                <button type="submit" class="btn btn-primary">Отправить</button>
            </form>
        </div>
    </div>
</div>

<script>
    const chatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/chat/' + {{ chat.id }} + '/'
    );

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const messagesDiv = document.getElementById('messages');
        const messageHtml = `
            <div style="margin-bottom: 10px; padding: 10px; border-radius: 5px; background-color: #f8f9fa; text-align: left;">
                <p><strong>${data.sender}</strong> (${data.sent_at}):</p>
                <p>${data.message}</p>
            </div>
        `;
        messagesDiv.innerHTML += messageHtml;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.getElementById('message-form').onsubmit = function(e) {
        e.preventDefault();
        const messageInput = document.querySelector('#id_text');
        const message = messageInput.value;
        chatSocket.send(JSON.stringify({
            'message': message
        }));
        messageInput.value = '';
    };
</script>
{% endblock %}